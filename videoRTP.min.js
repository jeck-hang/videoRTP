!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).videoRTP={})}(this,function(e){"use strict";function u(e,t,n,r,o,i,a){try{var c=e[i](a),u=c.value}catch(e){return void n(e)}c.done?t(u):Promise.resolve(u).then(r,o)}function t(c){return function(){var e=this,a=arguments;return new Promise(function(t,n){var r=c.apply(e,a);function o(e){u(r,t,n,o,i,"next",e)}function i(e){u(r,t,n,o,i,"throw",e)}o(void 0)})}}var s=window.constraints={audio:!1,video:!0};function d(e,t){document.querySelector("#errorMsg").innerHTML+="<p>".concat(e,"</p>"),void 0!==t&&console.error(t)}function c(){return(c=t(regeneratorRuntime.mark(function e(a){var c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.getUserMedia(s);case 3:return c=e.sent,o=void 0,o=a,i=(r=c).getVideoTracks(),console.log("Got stream with constraints:",s),console.log("Using video device: ".concat(i[0].label)),o.srcObject=r,e.abrupt("return",c);case 8:return e.prev=8,e.t0=e.catch(0),t=e.t0,"ConstraintNotSatisfiedError"===t.name?(n=s.video,d("The resolution ".concat(n.width.exact,"x").concat(n.height.exact," px is not supported by your device."))):"PermissionDeniedError"===t.name&&d("Permissions have not been granted to use your camera and microphone, you need to allow the page access to your devices in order for the demo to work."),d("getUserMedia error: ".concat(t.name),t),e.abrupt("return",Promise.reject(e.t0));case 12:case"end":return e.stop()}var t,n,r,o,i},e,null,[[0,8]])}))).apply(this,arguments)}function p(i,a,e){var c=2<arguments.length&&void 0!==e?e:{},u=null,t=null,n=new Promise(function(e){return t=e});function s(){return i.videoHeight||i.clientHeight}function d(){return i.videoWidth||i.clientWidth}function r(){var e,t=((e=document.createElement("canvas")).style.display="none",e.setAttribute("height",s()),e.setAttribute("width",d()),document.body.append(e),e),n=t.getContext("2d"),r=s(),o=d();u=setInterval(function(){n.drawImage(i,0,0,r,o),t.toBlob(function(e){a&&a(e)},"image/webp")},c.duration||200)}function o(){p(),t(),console.log("视频播放完毕！")}function p(){u&&clearInterval(u),i.removeEventListener("canplay",r,!1),i.removeEventListener("ended",o,!1),c.ended&&c.ended()}return i.addEventListener("canplay",r,!1),i.addEventListener("ended",o,!1),{stop:p,canvasRecordPromise:n}}function l(e,t,n,r){var o=3<arguments.length&&void 0!==r?r:{};return"undefined"!=typeof MediaRecorder?function(e,t,n){var r,o=2<arguments.length&&void 0!==n?n:{},i=null,a=o.collectTime||1e3,c={mimeType:"video/webm;codecs=vp9"},u=null;function s(e){e.data&&0<e.data.size&&t&&t(e.data)}return i=e,r={mimeType:"video/webm;codecs=vp9"},MediaRecorder.isTypeSupported(r.mimeType)||(console.error("".concat(r.mimeType," is not Supported")),r={mimeType:"video/webm;codecs=vp8"},MediaRecorder.isTypeSupported(r.mimeType)||(console.error("".concat(r.mimeType," is not Supported")),r={mimeType:"video/webm"},MediaRecorder.isTypeSupported(r.mimeType)||(console.error("".concat(r.mimeType," is not Supported")),r={mimeType:""}))),c=r,function(){try{u=new MediaRecorder(i,c)}catch(e){return console.error("Exception while creating MediaRecorder:",e)}u.onstop=function(e){u=null,o.ended&&o.ended()},u.ondataavailable=s,u.start(a)}(),e.onended=function(){e=i=null},u}(e,n,o):p(t,n,o)}var n=null;function o(){var e=function(){if(n)return n;var e=document.createElement("input");return(n=e).setAttribute("type","file"),e.setAttribute("accept","video/*"),e.setAttribute("capture","user"),e.style.display="none",document.body.append(e),e}();return new Promise(function(t){e.onchange=function(e){t(e.target.files[0])},e.click()})}var f={width:450,height:450,duration:100,MAXTIME:15,MINSIZE:1048576},m=window.URL||window.webkitURL;function i(){return(i=t(regeneratorRuntime.mark(function e(n,r,o){var i,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,o&&Object.assign(f,o),t=void 0,(t=document.createElement("video")).setAttribute("width",f.width),t.setAttribute("height",f.height),t.style.width=f.width,t.style.height=f.height,t.muted=!0,document.body.append(t),i=t,n.size<f.MINSIZE)return console.info("视频小于".concat(f.MINSIZE,", 不做处理")),r&&r(n),e.abrupt("return",n);e.next=7;break;case 7:return a=p(i,r,o),i.onloadedmetadata=function(){if(i.duration>f.MAXTIME)throw m.revokeObjectURL(i.src),a.stop(),new Error("视频时长".concat(i.duration,"超过").concat(f.MAXTIME))},e.next=11,function(n){var e=m.createObjectURL;return e?e(n):new Promise(function(e){var t=new FileReader;t.readAsDataURL(n),t.onload=function(){e(t.result)}})}(n);case 11:return i.src=e.sent,i.play(),e.abrupt("return",a);case 16:return e.prev=16,e.t0=e.catch(0),console.error(e.t0),e.abrupt("return",Promise.reject(e.t0));case 20:case"end":return e.stop()}var t},e,null,[[0,16]])}))).apply(this,arguments)}function v(){return!navigator.mediaDevices.getUserMedia}function h(){return r.apply(this,arguments)}function r(){return(r=t(regeneratorRuntime.mark(function e(t){var n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o();case 2:return n=e.sent,e.next=5,function(e,t,n){return i.apply(this,arguments)}(n,t.chunks,t);case 5:return r=e.sent,e.abrupt("return",r);case 7:case"end":return e.stop()}},e)}))).apply(this,arguments)}function a(){return(a=t(regeneratorRuntime.mark(function e(n){var r,o,i,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(v())return e.next=4,function(e){return c.apply(this,arguments)}(n.video);e.next=9;break;case 4:return r=e.sent,o=l(r,n.video,n.chunks,n),e.abrupt("return",{stop:function(){r.getTracks()[0].stop(),o.stop()}});case 9:if(n.degrade){e.next=11;break}return e.abrupt("return",Promise.reject({isWebrtcSurport:!1}));case 11:if(!0===n.degrade)return e.abrupt("return",h(n));e.next=13;break;case 13:if(n.degrade)return i=null,a=new Promise(function(e){return i=e}),("string"==typeof(t=n.degrade)?document.querySelector(t):t).addEventListener("click",function(){h(n).then(i)}),e.abrupt("return",a);e.next=18;break;case 18:case"end":return e.stop()}var t},e)}))).apply(this,arguments)}e.openVideo=function(e){return a.apply(this,arguments)},e.webrtcSurport=v,Object.defineProperty(e,"__esModule",{value:!0})});
