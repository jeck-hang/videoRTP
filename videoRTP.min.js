!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@babel/runtime-corejs3/core-js-stable/promise"),require("@babel/runtime-corejs3/regenerator"),require("@babel/runtime-corejs3/helpers/asyncToGenerator"),require("@babel/runtime-corejs3/core-js-stable/instance/concat"),require("@babel/runtime-corejs3/core-js-stable/set-interval"),require("@babel/runtime-corejs3/core-js-stable/object/assign")):"function"==typeof define&&define.amd?define(["exports","@babel/runtime-corejs3/core-js-stable/promise","@babel/runtime-corejs3/regenerator","@babel/runtime-corejs3/helpers/asyncToGenerator","@babel/runtime-corejs3/core-js-stable/instance/concat","@babel/runtime-corejs3/core-js-stable/set-interval","@babel/runtime-corejs3/core-js-stable/object/assign"],t):t((e=e||self).videoRTP={},e._Promise,e._regeneratorRuntime,e._asyncToGenerator,e._concatInstanceProperty,e._setInterval,e._Object$assign)}(this,function(e,p,s,t,d,f,c){"use strict";p=p&&Object.prototype.hasOwnProperty.call(p,"default")?p.default:p,s=s&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s,t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t,d=d&&Object.prototype.hasOwnProperty.call(d,"default")?d.default:d,f=f&&Object.prototype.hasOwnProperty.call(f,"default")?f.default:f,c=c&&Object.prototype.hasOwnProperty.call(c,"default")?c.default:c;var l=window.constraints={audio:!1,video:!0};function b(e,t){document.querySelector("#errorMsg").innerHTML+="<p>".concat(e,"</p>"),void 0!==t&&console.error(t)}function u(){return(u=t(s.mark(function e(c){var u;return s.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.getUserMedia(l);case 3:return u=e.sent,a=void 0,a=c,i=(o=u).getVideoTracks(),console.log("Got stream with constraints:",l),console.log("Using video device: ".concat(i[0].label)),a.srcObject=o,e.abrupt("return",u);case 8:return e.prev=8,e.t0=e.catch(0),t=e.t0,0,"ConstraintNotSatisfiedError"===t.name?(n=l.video,b(d(r="The resolution ".concat(n.width.exact,"x")).call(r,n.height.exact," px is not supported by your device."))):"PermissionDeniedError"===t.name&&b("Permissions have not been granted to use your camera and microphone, you need to allow the page access to your devices in order for the demo to work."),b("getUserMedia error: ".concat(t.name),t),e.abrupt("return",p.reject(e.t0));case 12:case"end":return e.stop()}var t,r,n,o,a,i},e,null,[[0,8]])}))).apply(this,arguments)}function m(a,i,e){var c=2<arguments.length&&void 0!==e?e:{},u=null,t=null,r=new p(function(e){return t=e});function s(){return a.videoHeight||a.clientHeight}function d(){return a.videoWidth||a.clientWidth}function n(){var e,t=((e=document.createElement("canvas")).style.display="none",e.setAttribute("height",s()),e.setAttribute("width",d()),document.body.append(e),e),r=t.getContext("2d"),n=s(),o=d();u=f(function(){r.drawImage(a,0,0,n,o),t.toBlob(function(e){i&&i(e)},"image/webp")},c.duration||200)}function o(){l(),t(),console.log("视频播放完毕！")}function l(){u&&clearInterval(u),a.removeEventListener("canplay",n,!1),a.removeEventListener("ended",o,!1),c.ended&&c.ended()}return a.addEventListener("canplay",n,!1),a.addEventListener("ended",o,!1),{stop:l,canvasRecordPromise:r}}function v(e,t,r,n){var o=3<arguments.length&&void 0!==n?n:{};return"undefined"!=typeof MediaRecorder?function(e,t,r){var n,o=2<arguments.length&&void 0!==r?r:{},a=null,i=o.collectTime||1e3,c={mimeType:"video/webm;codecs=vp9"},u=null;function s(e){e.data&&0<e.data.size&&t&&t(e.data)}return a=e,n={mimeType:"video/webm;codecs=vp9"},MediaRecorder.isTypeSupported(n.mimeType)||(console.error("".concat(n.mimeType," is not Supported")),n={mimeType:"video/webm;codecs=vp8"},MediaRecorder.isTypeSupported(n.mimeType)||(console.error("".concat(n.mimeType," is not Supported")),n={mimeType:"video/webm"},MediaRecorder.isTypeSupported(n.mimeType)||(console.error("".concat(n.mimeType," is not Supported")),n={mimeType:""}))),c=n,function(){try{u=new MediaRecorder(a,c)}catch(e){return console.error("Exception while creating MediaRecorder:",e)}u.onstop=function(e){u=null,o.ended&&o.ended()},u.ondataavailable=s,u.start(i)}(),e.onended=function(){e=a=null},u}(e,r,o):m(t,r,o)}var r=null;function o(){var e=function(){if(r)return r;var e=document.createElement("input");return(r=e).setAttribute("type","file"),e.setAttribute("accept","video/*"),e.setAttribute("capture","user"),e.style.display="none",document.body.append(e),e}();return new p(function(t){e.onchange=function(e){t(e.target.files[0])},e.click()})}var y={width:450,height:450,duration:100,MAXTIME:15,MINSIZE:1048576},h=window.URL||window.webkitURL;function a(){return(a=t(s.mark(function e(r,n,o){var a,i;return s.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,o&&c(y,o),t=void 0,(t=document.createElement("video")).setAttribute("width",y.width),t.setAttribute("height",y.height),t.style.width=y.width,t.style.height=y.height,t.muted=!0,document.body.append(t),a=t,r.size<y.MINSIZE)return console.info("视频小于".concat(y.MINSIZE,", 不做处理")),n&&n(r),e.abrupt("return",r);e.next=7;break;case 7:return i=m(a,n,o),a.onloadedmetadata=function(){var e;if(a.duration>y.MAXTIME)throw h.revokeObjectURL(a.src),i.stop(),new Error(d(e="视频时长".concat(a.duration,"超过")).call(e,y.MAXTIME))},e.next=11,function(r){var e=h.createObjectURL;return e?e(r):new p(function(e){var t=new FileReader;t.readAsDataURL(r),t.onload=function(){e(t.result)}})}(r);case 11:return a.src=e.sent,a.play(),e.abrupt("return",i);case 16:return e.prev=16,e.t0=e.catch(0),console.error(e.t0),e.abrupt("return",p.reject(e.t0));case 20:case"end":return e.stop()}var t},e,null,[[0,16]])}))).apply(this,arguments)}function w(){return!navigator.mediaDevices.getUserMedia}function g(){return n.apply(this,arguments)}function n(){return(n=t(s.mark(function e(t){var r,n;return s.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o();case 2:return r=e.sent,e.next=5,function(e,t,r){return a.apply(this,arguments)}(r,t.chunks,t);case 5:return n=e.sent,e.abrupt("return",n);case 7:case"end":return e.stop()}},e)}))).apply(this,arguments)}function i(){return(i=t(s.mark(function e(r){var n,o,a,i;return s.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(w())return e.next=4,function(e){return u.apply(this,arguments)}(r.video);e.next=9;break;case 4:return n=e.sent,o=v(n,r.video,r.chunks,r),e.abrupt("return",{stop:function(){n.getTracks()[0].stop(),o.stop()}});case 9:if(r.degrade){e.next=11;break}return e.abrupt("return",p.reject({isWebrtcSurport:!1}));case 11:if(!0===r.degrade)return e.abrupt("return",g(r));e.next=13;break;case 13:if(r.degrade)return a=null,i=new p(function(e){return a=e}),("string"==typeof(t=r.degrade)?document.querySelector(t):t).addEventListener("click",function(){g(r).then(a)}),e.abrupt("return",i);e.next=18;break;case 18:case"end":return e.stop()}var t},e)}))).apply(this,arguments)}e.openVideo=function(e){return i.apply(this,arguments)},e.webrtcSurport=w,Object.defineProperty(e,"__esModule",{value:!0})});
