"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var _Promise=_interopDefault(require("@babel/runtime-corejs3/core-js-stable/promise")),_regeneratorRuntime=_interopDefault(require("@babel/runtime-corejs3/regenerator")),_asyncToGenerator=_interopDefault(require("@babel/runtime-corejs3/helpers/asyncToGenerator")),_concatInstanceProperty=_interopDefault(require("@babel/runtime-corejs3/core-js-stable/instance/concat")),_setInterval=_interopDefault(require("@babel/runtime-corejs3/core-js-stable/set-interval")),_Object$assign=_interopDefault(require("@babel/runtime-corejs3/core-js-stable/object/assign")),constraints=window.constraints={audio:!1,video:!0};function handleSuccess(e,r){var t=r,n=e.getVideoTracks();console.log("Got stream with constraints:",constraints),console.log("Using video device: ".concat(n[0].label)),t.srcObject=e}function handleError(e){var r,t;"ConstraintNotSatisfiedError"===e.name?(t=constraints.video,errorMsg(_concatInstanceProperty(r="The resolution ".concat(t.width.exact,"x")).call(r,t.height.exact," px is not supported by your device."))):"PermissionDeniedError"===e.name&&errorMsg("Permissions have not been granted to use your camera and microphone, you need to allow the page access to your devices in order for the demo to work."),errorMsg("getUserMedia error: ".concat(e.name),e)}function errorMsg(e,r){document.querySelector("#errorMsg").innerHTML+="<p>".concat(e,"</p>"),void 0!==r&&console.error(r)}function openRTC(e){return _openRTC.apply(this,arguments)}function _openRTC(){return(_openRTC=_asyncToGenerator(_regeneratorRuntime.mark(function e(r){var t;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.getUserMedia(constraints);case 3:return handleSuccess(t=e.sent,r),e.abrupt("return",t);case 8:return e.prev=8,e.t0=e.catch(0),handleError(e.t0),e.abrupt("return",_Promise.reject(e.t0));case 12:case"end":return e.stop()}},e,null,[[0,8]])}))).apply(this,arguments)}function RTCRecord(e,r){var t,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},o=null,i=n.collectTime||1e3,a={mimeType:"video/webm;codecs=vp9"},c=null;function u(e){e.data&&0<e.data.size&&r&&r(e.data)}return o=e,t={mimeType:"video/webm;codecs=vp9"},MediaRecorder.isTypeSupported(t.mimeType)||(console.error("".concat(t.mimeType," is not Supported")),t={mimeType:"video/webm;codecs=vp8"},MediaRecorder.isTypeSupported(t.mimeType)||(console.error("".concat(t.mimeType," is not Supported")),t={mimeType:"video/webm"},MediaRecorder.isTypeSupported(t.mimeType)||(console.error("".concat(t.mimeType," is not Supported")),t={mimeType:""}))),a=t,function(){try{c=new MediaRecorder(o,a)}catch(e){return console.error("Exception while creating MediaRecorder:",e)}c.onstop=function(e){c=null,n.ended&&n.ended()},c.ondataavailable=u,c.start(i)}(),e.onended=function(){e=o=null},c}function CanvasRecord(i,a){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},u=null,r=null,e=new _Promise(function(e){return r=e});function s(){return i.videoHeight||i.clientHeight}function d(){return i.videoWidth||i.clientWidth}function t(){var e,r=((e=document.createElement("canvas")).style.display="none",e.setAttribute("height",s()),e.setAttribute("width",d()),document.body.append(e),e),t=r.getContext("2d"),n=s(),o=d();u=_setInterval(function(){t.drawImage(i,0,0,n,o),r.toBlob(function(e){a&&a(e)},"image/webp")},c.duration||200)}function n(){o(),r(),console.log("视频播放完毕！")}function o(){u&&clearInterval(u),i.removeEventListener("canplay",t,!1),i.removeEventListener("ended",n,!1),c.ended&&c.ended()}return i.addEventListener("canplay",t,!1),i.addEventListener("ended",n,!1),{stop:o,canvasRecordPromise:e}}function record(e,r,t){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{};return"undefined"!=typeof MediaRecorder?RTCRecord(e,t,n):CanvasRecord(r,t,n)}var getVideoByInput=null;function getInput(){if(getVideoByInput)return getVideoByInput;var e=document.createElement("input");return(getVideoByInput=e).setAttribute("type","file"),e.setAttribute("accept","video/*"),e.setAttribute("capture","user"),e.style.display="none",document.body.append(e),e}function getVideo(){var e=getInput();return new _Promise(function(r){e.onchange=function(e){r(e.target.files[0])},e.click()})}var config={width:450,height:450,duration:100,MAXTIME:15,MINSIZE:1048576},URL=window.URL||window.webkitURL;function createPlayVideo(){var e=document.createElement("video");return e.setAttribute("width",config.width),e.setAttribute("height",config.height),e.style.width=config.width,e.style.height=config.height,e.muted=!0,document.body.append(e),e}function getFileURL(t){var e=URL.createObjectURL;return e?e(t):new _Promise(function(e){var r=new FileReader;r.readAsDataURL(t),r.onload=function(){e(r.result)}})}function pressVideo(e,r,t){return _pressVideo.apply(this,arguments)}function _pressVideo(){return(_pressVideo=_asyncToGenerator(_regeneratorRuntime.mark(function e(r,t,n){var o,i;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,n&&_Object$assign(config,n),o=createPlayVideo(),r.size<config.MINSIZE)return console.info("视频小于".concat(config.MINSIZE,", 不做处理")),t&&t(r),e.abrupt("return",r);e.next=7;break;case 7:return i=CanvasRecord(o,t,n),o.onloadedmetadata=function(){var e;if(o.duration>config.MAXTIME)throw URL.revokeObjectURL(o.src),i.stop(),new Error(_concatInstanceProperty(e="视频时长".concat(o.duration,"超过")).call(e,config.MAXTIME))},e.next=11,getFileURL(r);case 11:return o.src=e.sent,o.play(),e.abrupt("return",i);case 16:return e.prev=16,e.t0=e.catch(0),console.error(e.t0),e.abrupt("return",_Promise.reject(e.t0));case 20:case"end":return e.stop()}},e,null,[[0,16]])}))).apply(this,arguments)}function webrtcSurport(){return!navigator.mediaDevices.getUserMedia}function getDOM(e){return"string"==typeof e?document.querySelector(e):e}function degrade(e){return _degrade.apply(this,arguments)}function _degrade(){return(_degrade=_asyncToGenerator(_regeneratorRuntime.mark(function e(r){var t,n;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,getVideo();case 2:return t=e.sent,e.next=5,pressVideo(t,r.chunks,r);case 5:return n=e.sent,e.abrupt("return",n);case 7:case"end":return e.stop()}},e)}))).apply(this,arguments)}function openVideo(e){return _openVideo.apply(this,arguments)}function _openVideo(){return(_openVideo=_asyncToGenerator(_regeneratorRuntime.mark(function e(r){var t,n,o,i;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(webrtcSurport())return e.next=4,openRTC(r.video);e.next=9;break;case 4:return t=e.sent,n=record(t,r.video,r.chunks,r),e.abrupt("return",{stop:function(){t.getTracks()[0].stop(),n.stop()}});case 9:if(r.degrade){e.next=11;break}return e.abrupt("return",_Promise.reject({isWebrtcSurport:!1}));case 11:if(!0===r.degrade)return e.abrupt("return",degrade(r));e.next=13;break;case 13:if(r.degrade)return o=null,i=new _Promise(function(e){return o=e}),getDOM(r.degrade).addEventListener("click",function(){degrade(r).then(o)}),e.abrupt("return",i);e.next=18;break;case 18:case"end":return e.stop()}},e)}))).apply(this,arguments)}exports.openVideo=openVideo,exports.webrtcSurport=webrtcSurport;
