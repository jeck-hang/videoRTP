"use strict";function asyncGeneratorStep(e,t,r,n,o,i,a){try{var c=e[i](a),u=c.value}catch(e){return void r(e)}c.done?t(u):Promise.resolve(u).then(n,o)}function _asyncToGenerator(c){return function(){var e=this,a=arguments;return new Promise(function(t,r){var n=c.apply(e,a);function o(e){asyncGeneratorStep(n,t,r,o,i,"next",e)}function i(e){asyncGeneratorStep(n,t,r,o,i,"throw",e)}o(void 0)})}}Object.defineProperty(exports,"__esModule",{value:!0});var constraints=window.constraints={audio:!1,video:!0};function handleSuccess(e,t){var r=t,n=e.getVideoTracks();console.log("Got stream with constraints:",constraints),console.log("Using video device: ".concat(n[0].label)),r.srcObject=e}function handleError(e){var t;"ConstraintNotSatisfiedError"===e.name?(t=constraints.video,errorMsg("The resolution ".concat(t.width.exact,"x").concat(t.height.exact," px is not supported by your device."))):"PermissionDeniedError"===e.name&&errorMsg("Permissions have not been granted to use your camera and microphone, you need to allow the page access to your devices in order for the demo to work."),errorMsg("getUserMedia error: ".concat(e.name),e)}function errorMsg(e,t){document.querySelector("#errorMsg").innerHTML+="<p>".concat(e,"</p>"),void 0!==t&&console.error(t)}function openRTC(e){return _openRTC.apply(this,arguments)}function _openRTC(){return(_openRTC=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.getUserMedia(constraints);case 3:return handleSuccess(r=e.sent,t),e.abrupt("return",r);case 8:return e.prev=8,e.t0=e.catch(0),handleError(e.t0),e.abrupt("return",Promise.reject(e.t0));case 12:case"end":return e.stop()}},e,null,[[0,8]])}))).apply(this,arguments)}function RTCRecord(e,t){var r,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},o=null,i=n.collectTime||1e3,a={mimeType:"video/webm;codecs=vp9"},c=null;function u(e){e.data&&0<e.data.size&&t&&t(e.data)}return o=e,r={mimeType:"video/webm;codecs=vp9"},MediaRecorder.isTypeSupported(r.mimeType)||(console.error("".concat(r.mimeType," is not Supported")),r={mimeType:"video/webm;codecs=vp8"},MediaRecorder.isTypeSupported(r.mimeType)||(console.error("".concat(r.mimeType," is not Supported")),r={mimeType:"video/webm"},MediaRecorder.isTypeSupported(r.mimeType)||(console.error("".concat(r.mimeType," is not Supported")),r={mimeType:""}))),a=r,function(){try{c=new MediaRecorder(o,a)}catch(e){return console.error("Exception while creating MediaRecorder:",e)}c.onstop=function(e){c=null,n.ended&&n.ended()},c.ondataavailable=u,c.start(i)}(),e.onended=function(){e=o=null},c}function CanvasRecord(i,a){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},u=null,t=null,e=new Promise(function(e){return t=e});function s(){return i.videoHeight||i.clientHeight}function d(){return i.videoWidth||i.clientWidth}function r(){var e,t=((e=document.createElement("canvas")).style.display="none",e.setAttribute("height",s()),e.setAttribute("width",d()),document.body.append(e),e),r=t.getContext("2d"),n=s(),o=d();u=setInterval(function(){r.drawImage(i,0,0,n,o),t.toBlob(function(e){a&&a(e)},"image/webp")},c.duration||200)}function n(){o(),t(),console.log("视频播放完毕！")}function o(){u&&clearInterval(u),i.removeEventListener("canplay",r,!1),i.removeEventListener("ended",n,!1),c.ended&&c.ended()}return i.addEventListener("canplay",r,!1),i.addEventListener("ended",n,!1),{stop:o,canvasRecordPromise:e}}function record(e,t,r){var n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{};return"undefined"!=typeof MediaRecorder?RTCRecord(e,r,n):CanvasRecord(t,r,n)}var getVideoByInput=null;function getInput(){if(getVideoByInput)return getVideoByInput;var e=document.createElement("input");return(getVideoByInput=e).setAttribute("type","file"),e.setAttribute("accept","video/*"),e.setAttribute("capture","user"),e.style.display="none",document.body.append(e),e}function getVideo(){var e=getInput();return new Promise(function(t){e.onchange=function(e){t(e.target.files[0])},e.click()})}var config={width:450,height:450,duration:100,MAXTIME:15,MINSIZE:1048576},URL=window.URL||window.webkitURL;function createPlayVideo(){var e=document.createElement("video");return e.setAttribute("width",config.width),e.setAttribute("height",config.height),e.style.width=config.width,e.style.height=config.height,e.muted=!0,document.body.append(e),e}function getFileURL(r){var e=URL.createObjectURL;return e?e(r):new Promise(function(e){var t=new FileReader;t.readAsDataURL(r),t.onload=function(){e(t.result)}})}function pressVideo(e,t,r){return _pressVideo.apply(this,arguments)}function _pressVideo(){return(_pressVideo=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n){var o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,n&&Object.assign(config,n),o=createPlayVideo(),t.size<config.MINSIZE)return console.info("视频小于".concat(config.MINSIZE,", 不做处理")),r&&r(t),e.abrupt("return",t);e.next=7;break;case 7:return i=CanvasRecord(o,r,n),o.onloadedmetadata=function(){if(o.duration>config.MAXTIME)throw URL.revokeObjectURL(o.src),i.stop(),new Error("视频时长".concat(o.duration,"超过").concat(config.MAXTIME))},e.next=11,getFileURL(t);case 11:return o.src=e.sent,o.play(),e.abrupt("return",i);case 16:return e.prev=16,e.t0=e.catch(0),console.error(e.t0),e.abrupt("return",Promise.reject(e.t0));case 20:case"end":return e.stop()}},e,null,[[0,16]])}))).apply(this,arguments)}function webrtcSurport(){return!navigator.mediaDevices.getUserMedia}function getDOM(e){return"string"==typeof e?document.querySelector(e):e}function degrade(e){return _degrade.apply(this,arguments)}function _degrade(){return(_degrade=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,getVideo();case 2:return r=e.sent,e.next=5,pressVideo(r,t.chunks,t);case 5:return n=e.sent,e.abrupt("return",n);case 7:case"end":return e.stop()}},e)}))).apply(this,arguments)}function openVideo(e){return _openVideo.apply(this,arguments)}function _openVideo(){return(_openVideo=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(webrtcSurport())return e.next=4,openRTC(t.video);e.next=9;break;case 4:return r=e.sent,n=record(r,t.video,t.chunks,t),e.abrupt("return",{stop:function(){r.getTracks()[0].stop(),n.stop()}});case 9:if(t.degrade){e.next=11;break}return e.abrupt("return",Promise.reject({isWebrtcSurport:!1}));case 11:if(!0===t.degrade)return e.abrupt("return",degrade(t));e.next=13;break;case 13:if(t.degrade)return o=null,i=new Promise(function(e){return o=e}),getDOM(t.degrade).addEventListener("click",function(){degrade(t).then(o)}),e.abrupt("return",i);e.next=18;break;case 18:case"end":return e.stop()}},e)}))).apply(this,arguments)}exports.openVideo=openVideo,exports.webrtcSurport=webrtcSurport;
