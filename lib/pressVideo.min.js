"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var _regeneratorRuntime=_interopDefault(require("@babel/runtime-corejs3/regenerator")),_concatInstanceProperty=_interopDefault(require("@babel/runtime-corejs3/core-js-stable/instance/concat")),_Object$assign=_interopDefault(require("@babel/runtime-corejs3/core-js-stable/object/assign")),_asyncToGenerator=_interopDefault(require("@babel/runtime-corejs3/helpers/asyncToGenerator")),_Promise=_interopDefault(require("@babel/runtime-corejs3/core-js-stable/promise")),_setInterval=_interopDefault(require("@babel/runtime-corejs3/core-js-stable/set-interval"));function CanvasRecord(i,a){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},s=null,t=null,e=new _Promise(function(e){return t=e});function u(){return i.videoHeight||i.clientHeight}function d(){return i.videoWidth||i.clientWidth}function r(){var e,t=((e=document.createElement("canvas")).style.display="none",e.setAttribute("height",u()),e.setAttribute("width",d()),document.body.append(e),e),r=t.getContext("2d"),n=u(),o=d();s=_setInterval(function(){r.drawImage(i,0,0,n,o),t.toBlob(function(e){a&&a(e)},"image/webp")},c.duration||200)}function n(){o(),t(),console.log("视频播放完毕！")}function o(){s&&clearInterval(s),i.removeEventListener("canplay",r,!1),i.removeEventListener("ended",n,!1),c.ended&&c.ended()}return i.addEventListener("canplay",r,!1),i.addEventListener("ended",n,!1),{stop:o,canvasRecordPromise:e}}var config={width:450,height:450,duration:100,MAXTIME:15,MINSIZE:1048576},URL=window.URL||window.webkitURL;function createPlayVideo(){var e=document.createElement("video");return e.setAttribute("width",config.width),e.setAttribute("height",config.height),e.style.width=config.width,e.style.height=config.height,e.muted=!0,document.body.append(e),e}function getFileURL(r){var e=URL.createObjectURL;return e?e(r):new _Promise(function(e){var t=new FileReader;t.readAsDataURL(r),t.onload=function(){e(t.result)}})}function pressVideo(e,t,r){return _pressVideo.apply(this,arguments)}function _pressVideo(){return(_pressVideo=_asyncToGenerator(_regeneratorRuntime.mark(function e(t,r,n){var o,i;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,n&&_Object$assign(config,n),o=createPlayVideo(),t.size<config.MINSIZE)return console.info("视频小于".concat(config.MINSIZE,", 不做处理")),r&&r(t),e.abrupt("return",t);e.next=7;break;case 7:return i=CanvasRecord(o,r,n),o.onloadedmetadata=function(){var e;if(o.duration>config.MAXTIME)throw URL.revokeObjectURL(o.src),i.stop(),new Error(_concatInstanceProperty(e="视频时长".concat(o.duration,"超过")).call(e,config.MAXTIME))},e.next=11,getFileURL(t);case 11:return o.src=e.sent,o.play(),e.abrupt("return",i);case 16:return e.prev=16,e.t0=e.catch(0),console.error(e.t0),e.abrupt("return",_Promise.reject(e.t0));case 20:case"end":return e.stop()}},e,null,[[0,16]])}))).apply(this,arguments)}exports.default=pressVideo;
