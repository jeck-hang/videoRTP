"use strict";function asyncGeneratorStep(e,t,n,r,o,i,a){try{var c=e[i](a),u=c.value}catch(e){return void n(e)}c.done?t(u):Promise.resolve(u).then(r,o)}function _asyncToGenerator(c){return function(){var e=this,a=arguments;return new Promise(function(t,n){var r=c.apply(e,a);function o(e){asyncGeneratorStep(r,t,n,o,i,"next",e)}function i(e){asyncGeneratorStep(r,t,n,o,i,"throw",e)}o(void 0)})}}function CanvasRecord(i,a){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},u=null,t=null,e=new Promise(function(e){return t=e});function s(){return i.videoHeight||i.clientHeight}function d(){return i.videoWidth||i.clientWidth}function n(){var e,t=((e=document.createElement("canvas")).style.display="none",e.setAttribute("height",s()),e.setAttribute("width",d()),document.body.append(e),e),n=t.getContext("2d"),r=s(),o=d();u=setInterval(function(){n.drawImage(i,0,0,r,o),t.toBlob(function(e){a&&a(e)},"image/webp")},c.duration||200)}function r(){o(),t(),console.log("视频播放完毕！")}function o(){u&&clearInterval(u),i.removeEventListener("canplay",n,!1),i.removeEventListener("ended",r,!1),c.ended&&c.ended()}return i.addEventListener("canplay",n,!1),i.addEventListener("ended",r,!1),{stop:o,canvasRecordPromise:e}}Object.defineProperty(exports,"__esModule",{value:!0});var config={width:450,height:450,duration:100,MAXTIME:15,MINSIZE:1048576},URL=window.URL||window.webkitURL;function createPlayVideo(){var e=document.createElement("video");return e.setAttribute("width",config.width),e.setAttribute("height",config.height),e.style.width=config.width,e.style.height=config.height,e.muted=!0,document.body.append(e),e}function getFileURL(n){var e=URL.createObjectURL;return e?e(n):new Promise(function(e){var t=new FileReader;t.readAsDataURL(n),t.onload=function(){e(t.result)}})}function pressVideo(e,t,n){return _pressVideo.apply(this,arguments)}function _pressVideo(){return(_pressVideo=_asyncToGenerator(regeneratorRuntime.mark(function e(t,n,r){var o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r&&Object.assign(config,r),o=createPlayVideo(),t.size<config.MINSIZE)return console.info("视频小于".concat(config.MINSIZE,", 不做处理")),n&&n(t),e.abrupt("return",t);e.next=7;break;case 7:return i=CanvasRecord(o,n,r),o.onloadedmetadata=function(){if(o.duration>config.MAXTIME)throw URL.revokeObjectURL(o.src),i.stop(),new Error("视频时长".concat(o.duration,"超过").concat(config.MAXTIME))},e.next=11,getFileURL(t);case 11:return o.src=e.sent,o.play(),e.abrupt("return",i);case 16:return e.prev=16,e.t0=e.catch(0),console.error(e.t0),e.abrupt("return",Promise.reject(e.t0));case 20:case"end":return e.stop()}},e,null,[[0,16]])}))).apply(this,arguments)}exports.default=pressVideo;
